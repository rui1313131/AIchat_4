!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("pixi.js")):"function"==typeof define&&define.amd?define(["exports","pixi.js"],t):t((e=e||self).PIXI.live2d={},e.PIXI)}(this,function(e,t){"use strict";var i=function(){return(i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function n(e,t,i,n){return new(i||(i=Promise))(function(o,r){function s(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){e.done?o(e.value):new i(function(t){t(e.value)}).then(s,a)}c((n=n.apply(e,t||[])).next())})}var o={};function r(e,t){e.uniforms.hasOwnProperty(t)||(e.uniforms[t]=o)}class s extends t.utils.EventEmitter{constructor(e,t,i){super(),this.settings=e,this.name=t,this.json=i,this.motions=this.createMotions(),this.expressions=this.createExpressions(),this.motions.forEach(e=>{var t;null===(t=this.emit("motionLoad",e))||void 0===t||t.catch(e=>console.error(e))}),this.expressions.forEach(e=>{var t;null===(t=this.emit("expressionLoad",e))||void 0===t||t.catch(e=>console.error(e))})}createMotions(){const e=this.json.motions;return e?Object.keys(e).map(t=>this.createMotion(e[t],t)):[]}createExpressions(){const e=this.json.expressions;return e?e.map(e=>this.createExpression(e)):[]}createMotion(e,t){return new d(this.settings,e,t)}createExpression(e){return new u(this.settings,e)}destroy(e){this.json=void 0,this.name=void 0,this.settings=void 0;for(const t of this.motions){t.destroy(e)}this.motions=void 0;for(const t of this.expressions){t.destroy(e)}this.expressions=void 0,super.destroy()}}var a=Float32Array,c=Uint16Array;const l=["ParamAngleX","ParamAngleY","ParamAngleZ","ParamEyeLOpen","ParamEyeLSmile","ParamEyeROpen","ParamEyeRSmile","ParamEyeBallX","ParamEyeBallY","ParamEyeBallForm","ParamBrowLY","ParamBrowRY","ParamBrowLX","ParamBrowRX","ParamBrowLAngle","ParamBrowRAngle","ParamBrowLForm","ParamBrowRForm","ParamMouthForm","ParamMouthOpenY","ParamCheek","ParamBodyAngleX","ParamBodyAngleY","ParamBodyAngleZ","ParamBreath","ParamArmLA","ParamArmRA","ParamArmLB","ParamArmRB","ParamHandL","ParamHandR","ParamHairFront","ParamHairSide","ParamHairBack","ParamHairFluffy","ParamShoulderY","ParamBustX","ParamBustY","ParamBaseX","ParamBaseY"];class h extends t.utils.EventEmitter{constructor(e){super(),this.settings=e,this.unmanaged=e.unmanaged,this.name=e.name,this.coreModel=e.coreModel,this.textures=e.textures,this.internalModel=e.internalModel,this.anchor=new t.Point,this.size=new t.Point,this._animator=e.animator,this._autoUpdate=!1,this.pixiListeners=[],this.tag="Live2DModel("+this.name+")",this.on("modelReady",()=>this.init())}static from(e){return n(this,void 0,void 0,function*(){const t="string"==typeof e;e=t?{path:e}:e;const i=yield(new N).load(e);return new h(i)})}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){this._autoUpdate?e||(this._autoUpdate=!1,t.Ticker.shared.remove(this.onTickerUpdate,this)):e&&(this._autoUpdate=!0,t.Ticker.shared.add(this.onTickerUpdate,this))}init(){this.size.set(this.internalModel.width,this.internalModel.height),this.anchor.set(.5,.5),this.internalModel.motionManager.on("motionStart",(e,t,i)=>this.emit("motionStart",e.name,t,i)),this.internalModel.motionManager.on("motionFinish",(e,t)=>this.emit("motionFinish",e.name,t)),this.setupInteraction()}setupInteraction(){this.interactive=!0,this.on("pointerdown",this.onPointerDown,this),this.on("pointermove",this.onPointerMove,this),this.on("pointerup",this.onPointerUp,this),this.on("pointerupoutside",this.onPointerUp,this)}onTickerUpdate(e){this.update(e.deltaMS)}update(e){this.emit("beforeUpdate"),this._animator.update(this,e),this.internalModel.update(e),this.emit("afterUpdate")}motion(e,t,i){return this.internalModel.motionManager.startMotion(e,t,i)}expression(e){return this.internalModel.motionManager.startExpression(e)}focus(e,t){this.internalModel.focusController.focus(e,t)}hitTest(e,t){return this.internalModel.hitTester.hitTest(e,t)}onPointerDown(e){const t=e.data.global;this.internalModel.focusController.focus(t.x,t.y),this.internalModel.hitTester.hitTest(e.data.global.x,e.data.global.y).forEach(t=>this.emit("hit",t,e))}onPointerMove(e){const t=e.data.global;this.internalModel.focusController.focus(t.x,t.y)}onPointerUp(e){this.emit("lift",e)}destroy(e){this.emit("destroy"),this.autoUpdate=!1,this.internalModel.destroy(),this._animator=void 0;const i={children:!0};e&&Object.assign(i,e instanceof t.DisplayObject?{}:e),this.unmanaged||this.textures.forEach(e=>e.destroy()),this.textures=void 0;for(const e of this.pixiListeners)e.destroy();this.pixiListeners=void 0,super.destroy(i)}}class d extends s{constructor(e,t,i){super(e,i,e.motions?e.motions[i]||t:t),this.group=i,this.priority=3,this.loop=t.loop,this.name=t.name,this._motion=void 0}get motion(){if(!this._motion){const e=this.json.motions;if(!e)return;const t=Object.keys(e)[0];this._motion=this.createMotion(e[t],t)}return this._motion}get expression(){return this.createExpression(this.json.expressions)}}class u extends s{constructor(e,t){super(e,t.name,e.expressions?e.expressions[t.name]||t:t)}}class m extends t.Geometry{constructor(e){super();const t=e.indices,i=e.vertices,n=e.uvs,o=t instanceof c;if(this.addAttribute("a_Position",i,2),this.addAttribute("a_TexCoord",n,2),this.addIndex(t),o){const e=new Int32Array(t.length);e.set(t),this.indexBuffer.update(e)}this.indices=t,this.vertices=i,this.uvs=n}update(e){const t=this.getBuffer("a_Position"),i=e.vertices;t.data.set(i),t.update()}}class g extends t.Mesh{constructor(e,t,i,n){super(new m(e),new p(t,n)),this.model=i,this.cullable=e.culling,this.texture=t;const o=this.shader.uniforms;o.u_Opacity=e.opacity,o.u_Mask=n.filterTexture,o.u_ModelMatrix=this.model.transform.worldTransform.toArray(!0),o.u_UseMask=!!n.filterTexture,this.blendMode=e.blendMode,this.interactive=!1}update(e){if(this.visible){const e=this.model.worldAlpha*this.shader.uniforms.u_Opacity;this.worldAlpha=e,e>0&&this.geometry.update(this.model.internalModel)}}destroy(e){super.destroy(e),this.model=void 0}}class p extends t.Shader{constructor(e,i){super(p.getProgram(!!i.filterTexture),{u_Sampler:e,u_Mask:i.filterTexture||t.Texture.WHITE,u_ModelMatrix:t.Matrix.IDENTITY.toArray(!0),u_UseMask:!1,u_Opacity:1}),this.id=Math.random()}static getProgram(e){return p.programs[e]||(p.programs[e]=new t.Program(f,w(e))),p.programs[e]}updateUniforms(e){const t=e.uniforms;r(t,"translationMatrix"),r(t,"projectionMatrix"),t.u_UseMask=!!t.u_Mask.baseTexture}}p.programs={};const f=`
    attribute vec2 a_Position;
    attribute vec2 a_TexCoord;

    uniform mat3 projectionMatrix;
    uniform mat3 u_ModelMatrix;

    varying vec2 v_TexCoord;

    void main() {
        vec3 pos = u_ModelMatrix * vec3(a_Position, 1.0);
        gl_Position = vec4((projectionMatrix * pos).xy, 0.0, 1.0);
        v_TexCoord = a_TexCoord;
    }
`;

const w=e=>`
varying vec2 v_TexCoord;

uniform sampler2D u_Sampler;
uniform sampler2D u_Mask;
uniform float u_Opacity;
uniform bool u_UseMask;

void main() {
    if (u_UseMask) {
        vec4 src = texture2D(u_Sampler, v_TexCoord);
        vec4 mask = texture2D(u_Mask, v_TexCoord);

        gl_FragColor = vec4(src.rgb, src.a * mask.r);
    } else {
        gl_FragColor = texture2D(u_Sampler, v_TexCoord);
    }

    gl_FragColor *= u_Opacity;
}
`;

var T,M;!function(e){e[e.VISIBLE=0]="VISIBLE",e[e.INVISIBLE=1]="INVISIBLE",e[e.OVERFLOW=2]="OVERFLOW"}(T||(T={}));!function(e){e[e.NORMAL=0]="NORMAL",e[e.ADD=1]="ADD",e[e.MULTIPLY=2]="MULTIPLY"}(M||(M={}));

class v{constructor(e,t){this.id=e,this.opacity=t,this._isVisible=!0}get isVisible(){return this._isVisible}set isVisible(e){this._isVisible=e}}class _ extends v{constructor(e,t,i,n,o,r){super(e,i),this.name=n,this.parent=t,this.indices=o,this.vertices=r,this.culling=!1,this.blendMode=M.NORMAL}update(e){this.indices=this.indices,this.vertices=this.vertices,this.opacity=this.opacity}}class y{constructor(e){if(this.motions=e.motions,this.expressions=e.expressions,this.name=e.name,this.tag="InternalModel("+this.name+")",this.width=e.width,this.height=e.height,this.coreModel=e.coreModel,this.motionManager=e.motionManager,this.focusController=e.focusController,this.hitTester=e.hitTester,this.textures=e.textures,this.masks=new S(this),this.drawables=[],e.drawables)for(const t of e.drawables){const e=new _(t.id,this,t.opacity,t.name,t.indices,t.vertices);e.culling=t.culling,e.blendMode=t.blendMode,this.drawables.push(e)}this.matrix=new t.Matrix,this.alpha=1}update(e){this.coreModel.update(),this.motionManager.update(this,e),this.focusController.update(e);for(const e of this.drawables)e.update(this)}destroy(){this.coreModel.release(),this.coreModel=void 0,this.motionManager.destroy(),this.motionManager=void 0,this.focusController=void 0,this.hitTester=void 0,this.motions=void 0,this.expressions=void 0,this.drawables=void 0,this.masks.destroy(),this.masks=void 0,this.textures=void 0}}class S{constructor(e){this.model=e,this.renderTexture=void 0,this.active=this.model.drawables.some(e=>e.parent instanceof v),this.destroy()}destroy(){this.renderTexture&&this.renderTexture.destroy(!0),this.renderTexture=void 0}render(e,i){if(this.active){this.renderTexture||(this.renderTexture=t.RenderTexture.create({width:e.width,height:e.height}));const n=new t.Matrix;n.scale(1,1),e.render(i,this.renderTexture,void 0,n,void 0)}}}class C extends t.utils.EventEmitter{constructor(e){super(),this.live2dModel=e,this.idleMotionName="Idle",this.expressionManager=new P,this.motions=[],this.queue=[],this.currentPriority=0,this.idling=!1}startMotion(e,t,i=3){return"string"==typeof e&&(e=this.live2dModel.motions[e]),e?(e.priority>this.currentPriority&&this.interrupt(),this.currentPriority=e.priority,this.idling=!1,e.isLooping&&this.motions.push(e),this.emit("motionStart",e,t,i),!0):!1}startExpression(e){return"string"==typeof e&&(e=this.live2dModel.expressions[e]),e?(this.expressionManager.setExpression(e),!0):!1}update(e,t){var i,n;if(null===(i=this.expressionManager)||void 0===i||i.update(e,t),this.motions.length>0){let i=!0;for(const n of this.motions)i=i&&!n.update(e,t);i&&this.motions.splice(0)}this.idling||0!==this.motions.length||(this.idling=!0,this.startMotion(this.idleMotionName,void 0,1)),null===(n=e.masks)||void 0===n||n.render(e.textures[0],e.drawables)}interrupt(){for(const e of this.motions)e instanceof d&&e.setFinished(this),this.emit("motionFinish",e,this);this.motions.splice(0),this.currentPriority=0}destroy(){super.destroy(),this.queue=void 0,this.motions=void 0,this.expressionManager=void 0}}class b{constructor(e){this.live2dModel=e,this.x=0,this.y=0}focus(e,t){this.x=e,this.y=t}update(e){const{x:t,y:i}=this.getCanvasPosition(),n=t-this.x,o=i-this.y;this.drag(n,o);const r=Math.sqrt(n*n+o*o);this.live2dModel.getParamFloat("ParamAngleX"),this.live2dModel.getParamFloat("ParamAngleY"),this.live2dModel.getParamFloat("ParamBodyAngleX");this.live2dModel.setParamFloat("ParamAngleX",this.live2dModel.getParamFloat("ParamAngleX")+30*n),this.live2dModel.setParamFloat("ParamAngleY",this.live2dModel.getParamFloat("ParamAngleY")+30*o),this.live2dModel.setParamFloat("ParamBodyAngleX",this.live2dModel.getParamFloat("ParamBodyAngleX")+10*n),this.live2dModel.setParamFloat("ParamEyeBallX",n),this.live2dModel.setParamFloat("ParamEyeBallY",o)}getCanvasPosition(){const e=this.live2dModel;return{x:(e.width-1)/2,y:(e.height-1)/2}}drag(e,t){this.live2dModel.getParamFloat("ParamDragX"),this.live2dModel.getParamFloat("ParamDragY");this.live2dModel.setParamFloat("ParamDragX",e),this.live2dModel.setParamFloat("ParamDragY",t)}}class I{constructor(e){this.live2dModel=e,this.hitAreas={}}hitTest(e,t){const i=[];for(const n in this.hitAreas)this.hitAreas.hasOwnProperty(n)&&this.isHit(n,e,t)&&i.push(n);return i}isHit(e,t,i){const{x:n,y:o}=this.hitAreas[e],r=this.live2dModel,s=r.drawables[o],a=r.getParamFloat(n);if(1===a){const e=s.indices,n=s.vertices;let o=-1,r=0;for(let s=0;s<e.length;s+=3){let a=n[2*e[s]],c=n[2*e[s]+1],l=n[2*e[s+1]],h=n[2*e[s+1]+1],d=n[2*e[s+2]],u=n[2*e[s+2]+1];(h-c)*(d-l)-(l-a)*(u-h)>=0&&((c-i)*(h-c)-(a-t)*(h-i)>0?o=-o:0,(h-i)*(u-h)-(l-t)*(u-i)>0?o=-o:0,(u-i)*(c-u)-(d-t)*(c-i)>0&&(o=-o)),-1===o&&(r=1-r)}if(r)return!0}return!1}}class P{constructor(){this.expressions=[],this.currentPriority=0}setExpression(e){e.priority>this.currentPriority&&(this.expressions.length>0&&(this.expressions[this.expressions.length-1].setFinished(!0),this.expressions.splice(0)),this.expressions.push(e))}update(e,t){for(const i in this.expressions)this.expressions.hasOwnProperty(i)&&!this.expressions[i].update(e,t)&&this.expressions.splice(0,1)}}const D=Object.freeze({__proto__:null,LOGICAL_WIDTH:1,LOGICAL_HEIGHT:1,fromYukari:function(e){const t=new FileReader;return new Promise((i,n)=>{t.onload=()=>i(JSON.parse(t.result)),t.onerror=n,t.readAsText(new Blob([e]))})}});class A{constructor(){this.xhr=new XMLHttpRequest,this.onProgress=this.onProgress.bind(this)}load(e,t,i){return new Promise(n=>{this.xhr.open("GET",e),this.xhr.responseType=t,this.xhr.onload=()=>n(this.xhr.response),this.onProgress&&(this.xhr.onprogress=i),this.xhr.send()})}onProgress(e){this.onProgress&&this.onProgress(e.target,e.loaded,e.total)}}class L{constructor(){this.loader=new A,this.cache=new Map}load(e,i){const o=i(e,this.loader);return n(this,void 0,void 0,function*(){const e=yield o;return this.cache.set(i,e),e})}release(e){this.cache.delete(e)}}const F={Yukari:"yukari",Moc:"moc",Motion:"motion",Expression:"expression",Physics:"physics",Pose:"pose",DisplayInfo:"cdi",Texture:"texture"};class N{constructor(e={}){this.listeners={},this.loader=new L,this.source=void 0,this.settings=void 0,this.moc=void 0,this.textures=[],this.name=void 0,this.motions=void 0,this.expressions=void 0,this.physics=void 0,this.pose=void 0,this.displayInfo=void 0,this.loadingState={},this.xhr=new A,this.cache=new Map,this.defaultMotionGroup="Idle",this.motionGroups={},this.expressionList=[],this.on("settingsJSONLoaded",(e,t)=>this.onSettingsJSONLoaded(e,t)),this.on("textureLoaded",(e,t)=>this.onTextureLoaded(e,t)),this.on("mocLoaded",e=>this.onMocLoaded(e)),this.on("physicsJSONLoaded",e=>this.onPhysicsJSONLoaded(e)),this.on("poseJSONLoaded",e=>this.onPoseJSONLoaded(e)),this.on("displayInfoJSONLoaded",e=>this.onDisplayInfoJSONLoaded(e)),this.on("motionLoaded",(e,t)=>this.onMotionLoaded(e,t)),this.on("expressionLoaded",e=>this.onExpressionLoaded(e))}load(e){return n(this,void 0,void 0,function*(){this.source=e,this.name=this.source.path.split("/").pop().replace(/\..+$/,"");const t=this.source.path;yield this.loader.load(t,this.loadJSON.bind(this));this.startLoading();const i=Object.keys(this.loadingState).map(e=>this.loadingState[e]);yield Promise.all(i);const n=this.createInternalModel();return{settings:this.settings,moc:this.moc,textures:this.textures,internalModel:n,animator:new U,unmanaged:!this.source.managed,name:this.name}})}loadJSON(e,t){return t.load(e,"json")}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach(i=>i.call(this,...t))}startLoading(){const e=this.loader.cache.get(this.loadJSON);this.settings=e,this.loadTextures(e.textures),this.loadMoc(e.moc),this.loadExpressions(e.expressions),this.loadMotions(e.motions),this.loadPhysics(e.physics),this.loadPose(e.pose),this.loadDisplayInfo(e.displayInfo)}onSettingsJSONLoaded(e,t){var i,n;this.settings=t,this.emit("settingsLoaded",t),this.loadTextures(null===(i=t.textures)||void 0===i?void 0:i.map(e=>this.getURL(e))),this.loadMoc(this.getURL(t.moc)),this.loadExpressions(t.expressions),this.loadMotions(t.motions),this.loadPhysics(this.getURL(t.physics)),this.loadPose(this.getURL(t.pose)),this.loadDisplayInfo(this.getURL(t.cdi)),null===(n=t.groups)||void 0===n||n.forEach(e=>this.registerMotionGroup(e.Name,e.Target,e.Ids))}loadTextures(e){const i=e.map((e,i)=>{this.loadingState["texture"+i]=this.loader.load(e,this.loadTexture.bind(this));const n=this.loader.cache.get(this.loadTexture);return this.textures[i]=n,this.emit("textureLoaded",i,n),this.loadingState["texture"+i]});return Promise.all(i)}loadTexture(e,t){return t.load(e,"").then(e=>({texture:t.Texture.from(e)}))}onTextureLoaded(e,i){this.textures[e]=i.texture,this.emit("texture"+e+"Loaded",i)}loadMoc(e){this.loadingState.moc=this.loader.load(e,this.loadMocFile.bind(this)),this.emit("mocLoaded",this.loader.cache.get(this.loadMocFile))}loadMocFile(e,t){return t.load(e,"arraybuffer")}onMocLoaded(e){this.moc=e,this.emit("mocReady",e)}loadExpressions(e){if(!e)return Promise.resolve([]);const t=e.map((e,t)=>{this.loadingState["expression"+t]=this.loader.load(this.getURL(e.file),this.loadJSON.bind(this));const i=this.loader.cache.get(this.loadJSON);return i.name=e.name,this.emit("expressionLoaded",i),this.loadingState["expression"+t]});return Promise.all(t)}onExpressionLoaded(e){this.expressionList.push(e)}loadMotions(e){if(!e)return Promise.resolve([]);let t=0;for(const i in e){const n=e[i];this.motionGroups[i]||(this.motionGroups[i]=[]),n.forEach(e=>{this.loadingState["motion"+t]=this.loader.load(this.getURL(e.file),this.loadMotionFile.bind(this));const n=this.loader.cache.get(this.loadMotionFile);this.emit("motionLoaded",i,n),t++})}return Promise.all(Object.values(this.loadingState))}loadMotionFile(e,t){return t.load(e,"json")}onMotionLoaded(e,t){this.motionGroups[e].push(t)}loadPhysics(e){if(!e)return Promise.resolve();this.loadingState.physics=this.loader.load(e,this.loadJSON.bind(this)),this.emit("physicsJSONLoaded",this.loader.cache.get(this.loadJSON))}onPhysicsJSONLoaded(e){this.physics=e,this.emit("physicsReady",e)}loadPose(e){if(!e)return Promise.resolve();this.loadingState.pose=this.loader.load(e,this.loadJSON.bind(this)),this.emit("poseJSONLoaded",this.loader.cache.get(this.loadJSON))}onPoseJSONLoaded(e){this.pose=e,this.emit("poseReady",e)}loadDisplayInfo(e){if(!e)return Promise.resolve();this.loadingState.displayInfo=this.loader.load(e,this.loadJSON.bind(this)),this.emit("displayInfoJSONLoaded",this.loader.cache.get(this.loadJSON))}onDisplayInfoJSONLoaded(e){this.displayInfo=e,this.emit("displayInfoReady",e)}getURL(e){return this.source.path.replace(/[^/]+$/,"")+e}createInternalModel(){const e=this.settings,t=this.moc,i={motions:this.motionGroups,expressions:this.expressionList,name:this.name,width:e.width||1,height:e.height||1,coreModel:t,motionManager:new C(this),focusController:new b(this),hitTester:new I(this),textures:this.textures};return new y(i)}release(){this.loader.release(this.loadJSON),this.loader.release(this.loadMocFile),this.loader.release(this.loadTexture),this.loader=void 0}}class U{constructor(){}update(e,t){}}Object.assign(e,{InternalModel:y,Live2DModel:h,Live2DModelSettings:s,Live2DMotion:d,Live2DExpression:u,XHRLoader:A,Yukari:D,config:{LOGICAL_WIDTH:1,LOGICAL_HEIGHT:1},utils:{l,applyMixins:function(e,t){t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(i=>{Object.defineProperty(e.prototype,i,Object.getOwnPropertyDescriptor(t.prototype,i))})})}}}),Object.defineProperty(e,"__esModule",{value:!0})});